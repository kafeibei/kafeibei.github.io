"use strict";!function(l){function s(t,i){this.options=$.extend({},$.fn.lotteryModal.defaults,t||{}),this.el=$(i).find(".lotteryModal"),this.init()}function t(){this.utils=l.utils}$.fn.lotteryModal=function(i){var e=Array.prototype.slice.call(arguments,1);return this.each(function(){var t=$(this).data("modal");t&&t[i]?t[i].apply(t,e):t=$(this).data("modal",new s(i,this))})},s.prototype={constructor:s,init:function(){this.utils=l.utils,this.events()},events:function(){var t="Other"==l.utils.mobileDevice()?"click":"touchstart";this.el.on(t,".no-win",$.proxy(this._closeDialog,this)).on(t,".btn-close",$.proxy(this._closeDialog,this)).on(t,".btn-detail",$.proxy(this._getDetail,this)).on(t,".btn-back",$.proxy(this._goBack,this))},lottery:function(t){this._lottery(t)},_lottery:function(l){var r=this;this.utils.loading.show(),this.utils.http({url:"../common/json/detail.json",success:function(t){if(t&&t.rewards){var i=t.rewards.length,e=r.utils.randomGap(i,0),s=t.rewards[e];s.num=e,l(1,s)}else l(-1,"奖项设置错误");r.utils.loading.close()},error:function(){l(-1,"奖项信息加载失败"),r.utils.loading.close(),r._closeDialog()}})},draw:function(t){t.status<0||!t.redeemable?this.noAward():(t.btn="close",this.drawPop(t),this.storageResult(t))},storageResult:function(t){var i=utils.storage.get("raffle_result")||[];if(!t)return i;i.push(t),utils.storage.set("raffle_result",i)},noAward:function(){this.drawPop({title:"很遗憾没有中奖",reward:"不要气馁，继续加油",btn:"close"})},drawPop:function(e){var t=this.el.find(".draw-wrap");t[0]||(t=$(this.options.draw_tpl).appendTo(this.el));var i=t.removeClass("hide").html();i=i.replace(/{{liv_(.*?)}}/g,function(t,i){return"pic"===i?e.pic?'<img src="'+e.pic+'" title="'+e.reward+'">':"":"pic_hide"===i?e.pic?t.replace("{{liv_"+i+"}}",""):"hide":t.replace("{{liv_"+i+"}}",e[i]||"")}).replace(/btn-(.*?) hide/g,function(t,i){return i===e.btn?"btn-"+i:t}),t.html(i)},result:function(){var t=this.storageResult();return t&&t[0]?this._renderResult(t):this.drawPop({title:"中奖结果",reward:"您还没有中奖纪录哦！",btn:"close"}),!1},_getDetail:function(t){var i=$(t.currentTarget).closest(".result-item").index(),e=this.resultData[i];$(".result-wrap").addClass("hide"),e.btn="back",this.drawPop(e)},_goBack:function(){$(".draw-wrap").remove(),$(".result-wrap").removeClass("hide")},_renderResult:function(t){var i=this.el.find("result-wrap");i[0]||(i=$(this.options.result_tpl).appendTo(this.el));var e=i.find(".results").empty();if(t&&t[0]){var s="",l=this.options.result_li;t.forEach(function(e,t){s+=l.replace(/{{liv_(.*?)}}/g,function(t,i){return"pic"===i?e.pic?'<img src="'+e.pic+'" title="'+e.reward+'">':"":"pic_hide"===i?e.pic?t.replace("{{liv_"+i+"}}",""):"hide":t.replace("{{liv_"+i+"}}",e[i]||"")})}),$(s).appendTo(e),this.resultData=t}},_closeDialog:function(t){$(".lotteryBox").addClass("hide"),$(".lotteryModal").empty().addClass("hide")}},$.fn.lotteryModal.defaults={result_tpl:'<div class="lottery-wrap result-wrap"><p class="title">中奖结果</p><ul class="results">{{liv_results}}</ul><em class="btn-close">关闭</em></div>',result_li:'<li class="result-item clear"><span class="img-box result-pic {{liv_pic_hide}}">{{liv_pic}}</span><span class="result-reward">{{liv_reward}}</span><button class="btn-detail">详情</button></li>',draw_tpl:'<div class="lottery-wrap draw-wrap hide"><p class="title">{{liv_title}}</p><div class="img-box draw-pic {{liv_pic_hide}}">{{liv_pic}}</div><p class="reward">{{liv_reward}}</p><em class="btn-close hide">关闭</em><em class="btn-back hide">返回</em></div>'},$.controlModal=function(t,i){var e=$(".lotteryBox");if(!e[0]){(e=$('<div class="lotteryBox hg-flex hg-flex-center hg-justify-center hide"> <div class="lotteryModal"></div></div>').appendTo("body")).on({_init:function(){e.lotteryModal(t)},_show:function(t,i){$(".lotteryModal").removeClass("hide"),e[("lottery"==i.func?"add":"remove")+"Class"]("hide").lotteryModal(i.func,i.cbk)},_hide:function(){e.addClass("hide")}});var s="Other"==l.utils.mobileDevice()?"click":"touchstart";e.on(s,function(t){t.stopPropagation(),!$(t.target).is(".lottery-wrap")&&$(t.target).closest(".lottery-wrap").length})}if("string"==typeof t)return e.trigger("_show",{func:t,cbk:i}),!1;e.trigger("_init")},t.prototype={constructor:t,init:function(){this._events()},_events:function(){this.element.on("click",".raffle-result",$.proxy(this._result,this)).on("click",".raffle-reset",$.proxy(this._reset,this)),this.extraEvent&&this.extraEvent()},initModal:function(t){$.controlModal({})},lotteryModal:function(s){$.controlModal("lottery",function(t,i){var e=parseInt(utils.storage.get("raffle_count"))||0;utils.storage.set("raffle_count",++e),s&&s(t,i)})},drawModal:function(t){$.controlModal("draw",t)},_reset:function(){this.initReset()},_result:function(){var e=this;$.controlModal("result",function(t,i){0<t||e.utils.toast(i)})},limit:function(){var t="",i=utils.storage.get("raffle_count")||0,e=utils.formatTime(null,"yyyy-MM-dd");return this.options.data&&(this.options.data.limit_count<=i?t="达到抽奖最大次数":this.options.start_time&&this.options.start_time>e?t="抽奖暂未开始":this.options.end_time&&this.options.end_time<e&&(t="抽奖已结束")),t}},l.Raffle=t}(window);